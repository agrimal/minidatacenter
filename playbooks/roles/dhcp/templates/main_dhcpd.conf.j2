# /etc/dhcp/dhcpd.conf
#
authoritative;
log-facility local0;
ddns-updates on;
ddns-update-style interim;
ignore client-updates;
ping-check true;
ping-timeout 2;
default-lease-time {{ dhcp_default_lease_time }};
max-lease-time {{ dhcp_max_lease_time }};

{% for pair_dns in dhcp_pair_dns %}
include "/etc/dhcp/key_{{ pair_dns }}_{{ hostvars[pair_dns]['dns_tsig_key_name'] }}";

{% for zone in dhcp_zones %}
{% if zone in hostvars[pair_dns]['dns_master_zones'] %}
{% for server in all_hosts_ips %}
{% if server.name == pair_dns %}
zone {{ zone }}. {
    primary {{ server.ip | ipaddr(hostvars[pair_dns]['dns_master_zones'][zone]) | ipaddr('address') | join(' ') }};
    key {{ hostvars[pair_dns]['dns_tsig_key_name'] }};
}

{% if 1 < hostvars[pair_dns]['dns_master_zones'][zone] | ipaddr('prefix') < 9 %} 
zone {{ hostvars[pair_dns]['dns_master_zones'][zone] | ipaddr('revdns') | regex_replace( '^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.', '') }} {
{% elif 8 < hostvars[pair_dns]['dns_master_zones'][zone] | ipaddr('prefix') < 17 %}
zone {{ hostvars[pair_dns]['dns_master_zones'][zone] | ipaddr('revdns') | regex_replace( '^\\d{1,3}\\.\\d{1,3}\\.', '') }} {
{% else %}
zone {{ hostvars[pair_dns]['dns_master_zones'][zone] | ipaddr('revdns') | regex_replace( '^\\d{1,3}\\.', '') }} {
{% endif %}
    primary {{ server.ip | ipaddr(hostvars[pair_dns]['dns_master_zones'][zone]) | ipaddr('address') | join(' ') }};
    key {{ hostvars[pair_dns]['dns_tsig_key_name'] }};
}

{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
{% endfor %}
{% for network in networks %}
subnet {{ network.cidr_ip | regex_replace('^(.*)/[0-9]+$', '\\1') }} netmask {{ network.cidr_ip | ipaddr('netmask') }} {
{% if network.name in dhcp_networks and network.dhcp_range %}
    range {{ network.dhcp_range }};
    {% if network.gateway -%}
    option routers {{ network.gateway }};
    {% endif -%}
    option domain-name-servers {{ network.dns_ip | join(', ') }};
    {% for pair_dns in dhcp_pair_dns -%}
    {% for domain, zone_network in hostvars[pair_dns]['dns_master_zones'].items() -%}
    {% if network.cidr_ip == zone_network and domain in dhcp_zones -%}
    option domain-name "{{ domain }}";
    ddns-domainname "{{ domain }}.";
    ddns-rev-domainname "in-addr.arpa.";
{% endif -%}
{% endfor -%}
{% endfor -%}
{% endif -%}
}

{% endfor %}
